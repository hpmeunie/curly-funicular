<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AV Schedule Viewer</title>

  <!-- PapaParse for robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      /* heights used for sticky offsets */
      --header-h: 56px;
      --filter-h: 52px;

      --bg: #f5f5f7;
      --text: #1c1c1e;
      --card: #ffffff;
      --border: #d2d2d7;
      --accent: #007aff;
      --muted: #6b6b6f;
      --maxw: 760px;
    }
    [data-theme="dark"] {
      --bg: #1c1c1e;
      --text: #f5f5f7;
      --card: #2c2c2e;
      --border: #3a3a3c;
      --accent: #0a84ff;
      --muted: #a0a0a4;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      /* Make room for the fixed header + filter */
      padding-top: calc(var(--header-h) + var(--filter-h));
    }

    /* Header (fixed) */
    header {
      position: fixed; top: 0; left: 0; right: 0;
      height: var(--header-h);
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.72);
      border-bottom: 1px solid var(--border);
      z-index: 30;
      color: var(--accent);
      font-weight: 600; font-size: 1.05rem;
    }
    [data-theme="dark"] header {
      background: rgba(28,28,30,0.72);
    }

    /* Filter bar (fixed under header) */
    .filter-bar {
      position: fixed; top: var(--header-h); left: 0; right: 0;
      height: var(--filter-h);
      z-index: 25;
      display: flex; align-items: center; justify-content: center;
      padding: 8px 12px;
      gap: 10px;
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      background: rgba(255,255,255,0.66);
      border-bottom: 1px solid var(--border);
      box-sizing: border-box;
    }
    [data-theme="dark"] .filter-bar {
      background: rgba(28,28,30,0.66);
    }

    .controls {
      width: 100%;
      max-width: var(--maxw);
      display: flex; gap: 10px; align-items: center; justify-content: space-between;
      padding: 0 10px;
      box-sizing: border-box;
    }

    select {
      width: 100%;
      max-width: 320px;
      padding: 10px 14px;
      font-size: 1rem; font-weight: 600;
      color: var(--text);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      appearance: none; -webkit-appearance: none;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }

    .theme-toggle {
      background: none;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      font-size: 1.1rem;
      padding: 6px 10px;
      cursor: pointer;
    }

    main {
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 12px;
      box-sizing: border-box;
    }

    /* Date sections */
    .date-section { margin-bottom: 22px; }

    .date-header {
      position: sticky;
      /* Sit exactly below the fixed header + filter */
      top: calc(var(--header-h) + var(--filter-h));
      z-index: 20; /* below filter (25), above cards */
      padding: 6px 0;
      text-align: center;
      font-weight: 700;
      font-size: 0.98rem;
      color: var(--muted);

      /* Give it a background so text isn‚Äôt overlaid by content behind */
      background: var(--bg);
      /* Optional subtle blur to match the UI */
      backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px);
      border-bottom: 1px solid transparent; /* keeps layout consistent */
    }

    /* Cards */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 10px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.06);
      transition: transform .15s ease, box-shadow .2s ease;
    }
    .card:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(0,0,0,0.10); }

    .row {
      display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;
    }
    .left { flex: 1 1 auto; min-width: 0; }
    .right { flex: 0 0 auto; min-width: 64px; text-align: right; color: var(--accent); font-weight: 600; }

    .room {
      font-weight: 700; font-size: 0.98rem; margin-bottom: 4px;
    }
    .session {
      font-size: 0.95rem; opacity: 0.95; margin-bottom: 6px;
    }
    .meta {
      font-size: 0.88rem; color: var(--muted);
    }

    @media (max-width: 420px) {
      select { max-width: 240px; }
      .card { padding: 11px 12px; }
      .right { min-width: 56px; }
    }
  </style>
</head>
<body data-theme="light">
  <header>AV Schedule Viewer</header>

  <div class="filter-bar">
    <div class="controls">
      <select id="roomFilter" aria-label="Filter by room">
        <option value="all">Show All Rooms</option>
      </select>
      <button id="themeToggle" class="theme-toggle" title="Toggle theme">üåô</button>
    </div>
  </div>

  <main>
    <div id="schedule"></div>
  </main>

  <script>
    const CSV_FILE = "Production Schedule Template - Sheet1 (4).csv";
    let allRows = [];
    let dateKey = "Day"; // will auto-detect "Day" or "Date"

    function detectDateKey(headers) {
      const candidates = ["Day", "Date", "day", "date", "DAY", "DATE"];
      for (const c of candidates) if (headers.includes(c)) return c;
      return null;
    }

    function isValidSession(row) {
      if (!row) return false;
      if (!row.Room || !row.Session || !row.Time) return false;
      const sess = String(row.Session).trim().toLowerCase();
      const day = String(row[dateKey] || "").trim().toLowerCase();
      if (day && sess === day) return false;
      return true;
    }

    function uniqueRooms(rows) {
      const set = new Set();
      rows.forEach(r => { if (r.Room && r.Room.trim()) set.add(r.Room.trim()); });
      return Array.from(set).sort((a,b)=>a.localeCompare(b));
    }

    function parseTimeToMinutes(t) {
      if (!t) return 24*60;
      const s = String(t).trim().replace(/\u00A0|\u202F/g, " ").replace(/\s+/g, " ");

      const ampm = s.match(/(\d{1,2}):?(\d{0,2})\s*([AaPp][Mm])/);
      if (ampm) {
        let hh = parseInt(ampm[1],10) || 0;
        let mm = ampm[2] ? parseInt(ampm[2],10) : 0;
        const mer = ampm[3].toLowerCase();
        if (mer === "pm" && hh !== 12) hh += 12;
        if (mer === "am" && hh === 12) hh = 0;
        return hh*60 + mm;
      }

      const hm = s.match(/(\d{1,2}):(\d{2})/);
      if (hm) return (parseInt(hm[1],10)*60) + parseInt(hm[2],10);

      const digits = s.match(/^\d{3,4}$/);
      if (digits) {
        const n = digits[0];
        if (n.length === 3) return (parseInt(n.slice(0,1),10)*60)+parseInt(n.slice(1),10);
        if (n.length === 4) return (parseInt(n.slice(0,2),10)*60)+parseInt(n.slice(2),10);
      }
      return 24*60;
    }

    function groupByDate(rows) {
      const order = [];
      const map = {};
      rows.forEach(r => {
        const key = String(r[dateKey] || "Unknown").trim();
        if (!map[key]) { map[key] = []; order.push(key); }
        map[key].push(r);
      });
      order.forEach(k => map[k].sort((a,b)=> parseTimeToMinutes(a.Time) - parseTimeToMinutes(b.Time)));
      return { order, map };
    }

    function populateRoomFilter(rooms) {
      const sel = document.getElementById("roomFilter");
      while (sel.options.length > 1) sel.remove(1);
      rooms.forEach(room => {
        const opt = document.createElement("option");
        opt.value = room;
        opt.textContent = room;
        sel.appendChild(opt);
      });
      sel.onchange = render;
    }

    function createCard(row) {
      const card = document.createElement("div");
      card.className = "card";
      const left = `
        <div class="left">
          <div class="room">${row.Room}</div>
          <div class="session">${row.Session}</div>
          <div class="meta">
            ${row.Tech ? `üë§ ${row.Tech}` : ""}${row.Tech && row.Gear ? " ¬∑ " : ""}${row.Gear ? `üéõÔ∏è ${row.Gear}` : ""}
          </div>
        </div>
      `;
      const right = `<div class="right">${row.Time || ""}</div>`;
      card.innerHTML = `<div class="row">${left}${right}</div>`;
      return card;
    }

    function render() {
      const container = document.getElementById("schedule");
      container.innerHTML = "";

      const room = document.getElementById("roomFilter").value;
      const rows = allRows.filter(r => isValidSession(r) && (room === "all" || String(r.Room).trim() === room));

      const { order, map } = groupByDate(rows);

      order.forEach(day => {
        const list = map[day];
        if (!list || !list.length) return;

        const section = document.createElement("section");
        section.className = "date-section";

        const header = document.createElement("div");
        header.className = "date-header";
        header.textContent = day;
        section.appendChild(header);

        list.forEach(row => section.appendChild(createCard(row)));

        container.appendChild(section);
      });
    }

    function initThemeToggle() {
      const btn = document.getElementById("themeToggle");
      btn.onclick = () => {
        const next = document.body.getAttribute("data-theme") === "dark" ? "light" : "dark";
        document.body.setAttribute("data-theme", next);
        btn.textContent = next === "dark" ? "‚òÄÔ∏è" : "üåô";
        localStorage.setItem("theme", next);
      };
      const saved = localStorage.getItem("theme");
      if (saved) {
        document.body.setAttribute("data-theme", saved);
        btn.textContent = saved === "dark" ? "‚òÄÔ∏è" : "üåô";
      }
    }

    function loadCSV() {
      Papa.parse(CSV_FILE, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
          const rows = (res.data || []).map(r => {
            const out = {};
            for (const k in r) out[k] = typeof r[k] === "string" ? r[k].trim() : r[k];
            return out;
          });

          if (rows.length) {
            const headers = Object.keys(rows[0]);
            const dk = detectDateKey(headers);
            if (dk) dateKey = dk;
          }

          allRows = rows;

          const rooms = uniqueRooms(allRows.filter(isValidSession));
          populateRoomFilter(rooms);

          render();
        },
        error: (err) => {
          document.getElementById("schedule").textContent = "Failed to load schedule.";
          console.error(err);
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      initThemeToggle();
      loadCSV();
    });
  </script>
</body>
</html>
